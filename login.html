<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Artepisa SLP · Login (OneDrive/SharePoint)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/style.css">

  <!-- (Opcional) CSP sugerida: ajusta dominios/paths a tu hosting -->
  <!--
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data: https:;
                 script-src 'self' https://alcdn.msauth.net 'unsafe-inline';
                 style-src 'self' 'unsafe-inline' https:;
                 connect-src https://graph.microsoft.com https://login.microsoftonline.com;">
  -->
</head>
<body class="theme-light">
<header class="brand">
  <div class="logo">
    <img class="brandlogo" src="./img/arte.png?v=1" alt="ARTEPISA SLP">
    <div>
      <div class="brandname">ARTEPISA SLP</div>
      <div class="muted">Acceso y configuración de datos en OneDrive</div>
    </div>
  </div>

  <div class="actions" style="margin:0">
    <a id="link-panel" class="btn ghost" href="dashboard.html" style="display:none">Ir al panel</a>
    <button id="btn-logout" class="btn ghost" type="button" style="display:none">Cerrar sesión</button>
    <a class="btn ghost" href="dashboard.html">Volver</a>
  </div>
</header>

<main class="container hero">
  <!-- CARD LOGIN -->
  <section class="card" id="card-login" aria-labelledby="login-title">
    <h1 id="login-title">Iniciar sesión con Microsoft</h1>
    <p class="muted">
      Los datos se guardarán en una <b>carpeta compartida de OneDrive</b> (gratis). Todos verán la misma información.
    </p>

    <div class="actions">
      <button class="btn" id="btn-login" type="button">
        <svg width="18" height="18" viewBox="0 0 23 23" aria-hidden="true" focusable="false">
          <rect width="10.5" height="10.5" x="1" y="1" fill="#f25022"/>
          <rect width="10.5" height="10.5" x="11.5" y="1" fill="#7fba00"/>
          <rect width="10.5" height="10.5" x="1" y="11.5" fill="#00a4ef"/>
          <rect width="10.5" height="10.5" x="11.5" y="11.5" fill="#ffb900"/>
        </svg>
        <span class="btn-label">Entrar con Microsoft</span>
        <span class="spinner" aria-hidden="true"></span>
      </button>
    </div>

    <p id="login-msg" class="muted" aria-live="polite"></p>

    <details style="margin-top:10px">
      <summary>¿Cómo configuro MSAL y la carpeta en la nube?</summary>
      <ol>
        <li>Registra una app en <b>Azure Portal → App registrations</b> (tipo SPA).</li>
        <li>En <b>Authentication</b>, agrega Redirect URI:
          <code>https://TU_DOMINIO/index.html</code> (y en local <code>http://localhost:5500/index.html</code> por ejemplo).
        </li>
        <li>Permisos delegados:
          <b>User.Read</b>, <b>Files.ReadWrite</b> (o <b>Files.ReadWrite.All</b> si prefieres), y <b>offline_access</b>.
        </li>
        <li>En <code>js/msal-config.js</code> pega tu <code>clientId</code> y deja <code>authority</code> en
          <code>consumers</code> para cuentas personales.
        </li>
        <li>Asegúrate de tener <code>window.GRAPH_STORAGE</code> configurado con <code>location:"me"</code> y
          <code>folderPath:"/ArtepisaData"</code> (ver bloque de configuración más abajo).</li>
      </ol>
    </details>
  </section>

  <!-- CARD USUARIOS / PRIVILEGIOS (solo visible para ADMIN y si hay sesión) -->
  <section class="card" id="card-roles" style="display:none">
    <h2>Usuarios y privilegios</h2>
    <p class="muted" id="roles-msg">Solo los <b>ADMIN</b> pueden ver y editar esta sección.</p>

    <div class="form" id="roles-form">
      <div class="field">
        <label for="u-email">Correo (UPN)</label>
        <input id="u-email" type="email" class="input" placeholder="usuario@empresa.com">
      </div>
      <div class="field">
        <label for="u-nombre">Nombre</label>
        <input id="u-nombre" class="input" placeholder="Nombre a mostrar">
      </div>
      <div class="field">
        <label for="u-rol">Rol</label>
        <select id="u-rol" class="input">
          <option value="ADMIN">ADMIN</option>
          <option value="EDITOR">EDITOR</option>
          <option value="LECTOR">LECTOR</option>
        </select>
      </div>
      <div class="field">
        <label class="pill"><input id="u-activo" type="checkbox" checked> &nbsp; Activo</label>
      </div>

      <div class="actions">
        <button class="btn" id="u-guardar" type="button">Guardar</button>
        <button class="btn ghost" id="u-nuevo" type="button">Nuevo</button>
        <button class="btn danger" id="u-eliminar" type="button">Eliminar</button>
        <span class="spacer" style="flex:1"></span>
        <input id="u-buscar" class="input" placeholder="Buscar por correo o nombre…" style="min-width:240px">
      </div>
    </div>

    <div class="table-wrap" style="margin-top:10px">
      <table class="table">
        <thead>
          <tr><th>Correo</th><th>Nombre</th><th>Rol</th><th>Activo</th><th></th></tr>
        </thead>
        <tbody id="u-tabla"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- ============ CONFIGURACIÓN DE ALMACENAMIENTO COMPARTIDO ============ -->
<script>
  // Usa OneDrive personal (gratis), carpeta compartida con "Puede editar"
  // Todos los usuarios deben tener añadido el acceso directo a esta carpeta en su OneDrive.
  window.GRAPH_STORAGE = {
    location  : "me",              // OneDrive personal (no SharePoint)
    folderPath: "/ArtepisaData"    // nombre EXACTO de la carpeta compartida
  };
</script>

<!-- MSAL (browser) -->
<script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>

<!-- App config y auth -->
<script src="./js/msal-config.js"></script>
<script src="./js/auth.js"></script>

<!-- Graph & capa de datos (para guardar users.json, etc.) -->
<script src="./js/graph.js"></script>
<script src="./js/data.js"></script>

<!-- Roles (debe cargarse ANTES de usuarios.js) -->
<script src="./js/roles.js?v=1"></script>

<!-- Gestión de usuarios/roles -->
<script src="./js/usuarios.js?v=1"></script>

<script>
  (function(){
    const $ = (s) => document.querySelector(s);
    const btnLogin  = $("#btn-login");
    const btnLogout = $("#btn-logout");
    const linkPanel = $("#link-panel");
    const msg       = $("#login-msg");
    const spinner   = btnLogin?.querySelector(".spinner");
    const label     = btnLogin?.querySelector(".btn-label");
    const rolesCard = $("#card-roles");

    function setMsg(text, { show = true, isError = false } = {}) {
      msg.textContent = text || "";
      msg.hidden = !show || !text;
      if (isError) msg.setAttribute("role","alert"); else msg.removeAttribute("role");
    }
    function startLoading(text="Procesando…"){
      btnLogin.disabled = true; btnLogout.disabled = true;
      spinner?.classList.add("on");
      if (label) label.textContent = text;
      setMsg(text, { show:true });
    }
    function stopLoading(){
      spinner?.classList.remove("on");
      if (label) label.textContent = "Entrar con Microsoft";
      btnLogin.disabled = false; btnLogout.disabled = false;
    }
    function setLoggedInUI(account){
      linkPanel.style.display = "inline-block";
      btnLogout.style.display = "inline-block";
      btnLogin.style.display  = "none";
      stopLoading();
      setMsg(`Conectado como: ${account?.name || account?.username || "sesión activa"}`, { show:true });
    }
    function setLoggedOutUI(){
      linkPanel.style.display = "none";
      btnLogout.style.display = "none";
      btnLogin.style.display  = "inline-block";
      stopLoading();
      setMsg("No has iniciado sesión.", { show:true });
    }

    async function ensureRoleUI(){
      try{
        await Roles.init();
        if (Roles.meets("ADMIN")){
          rolesCard.style.display = "block";
        } else {
          rolesCard.style.display = "none";
        }
      }catch(e){
        console.warn("Roles no disponibles aún:", e);
        rolesCard.style.display = "none";
      }
    }

    // Estado inicial
    (async function init(){
      try{
        const acct = (window.MSALApp && MSALApp.getAccount) ? await MSALApp.getAccount() : null;
        if (acct){
          setLoggedInUI(acct);
          await ensureRoleUI();
          btnLogin.onclick = () => location.href = "dashboard.html";
        } else {
          setLoggedOutUI();
        }
      }catch(e){
        console.warn(e);
        setLoggedOutUI();
      }
    })();

    // Handlers
    btnLogin?.addEventListener("click", async () => {
      if (!(window.MSALApp && MSALApp.login)) {
        setMsg("MSAL no está listo. Verifica que 'msal-config.js' y 'auth.js' carguen correctamente.", { show:true, isError:true });
        return;
      }
      startLoading("Abriendo Microsoft…");
      try{
        await MSALApp.login();
        const acct = (window.MSALApp && MSALApp.getAccount) ? await MSALApp.getAccount() : null;
        if (acct) {
          setLoggedInUI(acct);
          await ensureRoleUI();
          // Puedes redirigir directo si prefieres:
          // location.href = "dashboard.html";
        } else {
          setMsg("Sesión iniciada, pero no se pudo leer el perfil. Revisa auth.js.", { show:true, isError:true });
        }
      }catch(e){
        console.error(e);
        setMsg(`No se pudo iniciar sesión: ${e?.message || e}`, { show:true, isError:true });
        setLoggedOutUI();
      }
    });

    btnLogout?.addEventListener("click", async () => {
      if (!(window.MSALApp && MSALApp.logout)) {
        setMsg("MSAL no está listo para cerrar sesión.", { show:true, isError:true });
        return;
      }
      startLoading("Cerrando sesión…");
      try{ await MSALApp.logout(); }
      finally{
        sessionStorage.removeItem("artepisa_account");
        setLoggedOutUI();
      }
    });
  })();
</script>
</body>
</html>
