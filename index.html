<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Artepisa SLP · Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS principal -->
  <link rel="stylesheet" href="./css/style.css">

  <!-- Recomendación: pequeña reserva de estilos por si el CSS externo no carga -->
  <style>
    /* Fallback mínimo, puedes quitarlo si quieres */
    :root{--radius:14px;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0f172a;color:#e5e7eb}
    .brand{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1f2937;background:#111827}
    .logo{display:flex;gap:12px;align-items:center}
    .brandlogo{height:44px;width:auto;border-radius:8px;background:#fff}
    .brandname{font-weight:700}
    .muted{opacity:.8;font-size:.95rem}
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:var(--radius);padding:18px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .btn{border:1px solid #374151;background:#2563eb;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:transparent;color:#e5e7eb}
    code{background:#0b1220;padding:2px 6px;border-radius:6px}
    details{background:#0b1220;border:1px solid #172033;border-radius:10px;padding:10px}
    summary{cursor:pointer}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>

  <!-- Recomendado: CSP básica (ajústala a tu dominio/producto) -->
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: https:; script-src 'self' https://alcdn.msauth.net 'unsafe-inline'; style-src 'self' 'unsafe-inline' https:; connect-src https://graph.microsoft.com https://login.microsoftonline.com;"> -->
</head>
<body>
<header class="brand">
  <div class="logo">
    <img class="brandlogo" src="./img/arte.png?v=1" alt="ARTEPISA SLP">
    <div>
      <div class="brandname">ARTEPISA SLP</div>
      <div class="muted">Registro de Órdenes de Trabajo</div>
    </div>
  </div>
  <!-- Oculto por defecto; se muestra sólo si hay sesión -->
  <a id="link-panel" class="btn ghost" href="dashboard.html" style="display:none">Ir al panel</a>
</header>

<main class="container">
  <section class="card">
    <h1>Iniciar sesión con Microsoft</h1>
    <p class="muted">Solo entrar con <b>cuenta personal</b> (MSA). Si usas cuenta corporativa, revisa permisos.</p>

    <div class="actions">
      <button class="btn" id="btn-login">Entrar con Microsoft</button>
      <button class="btn ghost" id="btn-logout" style="display:none">Cerrar sesión</button>
    </div>

    <!-- Mensajes de estado (accesible y visible cuando sea necesario) -->
    <p id="login-msg" class="muted" aria-live="polite"></p>
  </section>
</main>

<!-- MSAL (browser) -->
<script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js" defer></script>
<!-- Config y auth -->
<script src="./js/msal-config.js" defer></script>
<script src="./js/auth.js" defer></script>

<script>
  // Estado UI según sesión + mejoras de accesibilidad y robustez
  (function () {
    const $ = (sel) => document.querySelector(sel);
    const linkPanel = $("#link-panel");
    const btnLogin  = $("#btn-login");
    const btnLogout = $("#btn-logout");
    const msg       = $("#login-msg");

    // Helpers UI
    function setMsg(text, { show = true } = {}) {
      if (!msg) return;
      msg.textContent = text || "";
      msg.hidden = !show || !text;
    }

    function setLoggedInUI(account) {
      linkPanel.style.display = "inline-block";
      btnLogout.style.display = "inline-block";
      btnLogin.style.display  = "none";
      btnLogin.disabled = false;
      btnLogout.disabled = false;
      setMsg(`Conectado como: ${account?.name || account?.username || "sesión activa"}`, { show: true });
    }

    function setLoggedOutUI() {
      linkPanel.style.display = "none";
      btnLogout.style.display = "none";
      btnLogin.style.display  = "inline-block";
      btnLogin.disabled = false;
      btnLogout.disabled = false;
      setMsg("No has iniciado sesión.", { show: true });
    }

    function setLoadingUI(text = "Procesando…") {
      btnLogin.disabled = true;
      btnLogout.disabled = true;
      setMsg(text, { show: true });
    }

    // Cargar estado guardado (si auth.js ya inició sesión previamente)
    try {
      const acct = JSON.parse(sessionStorage.getItem("artepisa_account") || "null");
      if (acct) setLoggedInUI(acct);
      else setLoggedOutUI();
    } catch {
      setLoggedOutUI();
    }

    // Eventos de click (idempotentes si auth.js ya los registró)
    btnLogin?.addEventListener("click", async () => {
      if (!(window.MSALApp && MSALApp.login)) {
        setMsg("MSAL no está listo. Verifica que 'msal-config.js' y 'auth.js' carguen correctamente.", { show: true });
        return;
      }
      setLoadingUI("Abriendo ventana de Microsoft…");
      try {
        await MSALApp.login(); // auth.js debe guardar artepisa_account en sessionStorage
        const acct = JSON.parse(sessionStorage.getItem("artepisa_account") || "null");
        if (acct) setLoggedInUI(acct);
        else setMsg("Sesión iniciada, pero no se pudo leer el perfil. Revisa auth.js.", { show: true });
      } catch (e) {
        setMsg(`No se pudo iniciar sesión: ${e?.message || e}`, { show: true });
        setLoggedOutUI();
      }
    });

    btnLogout?.addEventListener("click", async () => {
      if (!(window.MSALApp && MSALApp.logout)) {
        setMsg("MSAL no está listo para cerrar sesión.", { show: true });
        return;
      }
      setLoadingUI("Cerrando sesión…");
      try {
        await MSALApp.logout();
      } finally {
        // Limpieza defensiva
        sessionStorage.removeItem("artepisa_account");
        setLoggedOutUI();
      }
    });

    // Opcional: escucha eventos personalizados que puedas emitir desde auth.js
    // window.addEventListener("artepisa:auth:success", (ev) => {
    //   const acct = ev.detail?.account || JSON.parse(sessionStorage.getItem("artepisa_account") || "null");
    //   setLoggedInUI(acct);
    // });
    // window.addEventListener("artepisa:auth:error", (ev) => {
    //   setMsg(`Error de autenticación: ${ev.detail?.error || "desconocido"}`, { show: true });
    //   setLoggedOutUI();
    // });
  })();
</script>
</body>
</html>

