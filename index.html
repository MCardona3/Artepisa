<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Artepisa SLP · Login (OneDrive/SharePoint)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
<header class="brand">
  <div class="logo">
    <img class="brandlogo" src="./img/arte.png?v=1" alt="ARTEPISA SLP">
    <div>
      <div class="brandname">ARTEPISA SLP</div>
      <div class="muted">Clientes (OneDrive/SharePoint)</div>
    </div>
  </div>
  <!-- Oculto por defecto; se muestra sólo si hay sesión -->
  <a id="link-panel" class="btn ghost" href="dashboard.html" style="display:none">Ir al panel</a>
</header>

<main class="container">
  <section class="card">
    <h1>Iniciar sesión con Microsoft</h1>
    <p class="muted">Se guardará en una carpeta compartida de OneDrive o en una biblioteca de SharePoint.</p>

    <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btn-login">Entrar con Microsoft</button>
      <button class="btn ghost" id="btn-logout" style="display:none">Cerrar sesión</button>
    </div>

    <p id="login-msg" class="muted"></p>

    <details style="margin-top:10px">
      <summary>¿Cómo configuro MSAL y la carpeta en la nube?</summary>
      <ol>
        <li>Registra una app en <b>Azure Portal → App registrations</b> (tipo SPA).</li>
        <li>En <b>Authentication</b>, agrega Redirect URI: <code>https://TU_USUARIO.github.io/TU_REPO/index.html</code> (y opcional <code>http://localhost:5500/index.html</code>).</li>
        <li>Permisos delegados: <b>User.Read</b> y <b>Files.ReadWrite</b> (o <b>Files.ReadWrite.All</b> si lo requieres).</li>
        <li>Edita <code>js/msal-config.js</code> con tu <code>clientId</code> y revisa el <i>redirectUri</i> (ya se ajusta solo para GitHub Pages).</li>
      </ol>
    </details>
  </section>
</main>

<!-- MSAL (browser) -->
<script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
<!-- Config y auth -->
<script src="./js/msal-config.js"></script>
<script src="./js/auth.js"></script>

<script>
  // UI según sesión
  (function () {
    const acct = JSON.parse(sessionStorage.getItem("artepisa_account") || "null");
    const linkPanel = document.getElementById("link-panel");
    const btnLogin  = document.getElementById("btn-login");
    const btnLogout = document.getElementById("btn-logout");
    const msg       = document.getElementById("login-msg");

    if (acct) {
      // Ya logueado: muestra "Ir al panel" y "Cerrar sesión"
      linkPanel.style.display = "inline-block";
      btnLogout.style.display = "inline-block";
      btnLogin.style.display  = "none";
      msg.textContent = `Conectado como: ${acct.name || acct.username || ""}`;
    } else {
      // No logueado: sólo botón de login
      linkPanel.style.display = "none";
      btnLogout.style.display = "none";
      btnLogin.style.display  = "inline-block";
      msg.textContent = "No has iniciado sesión.";
    }

    // Por si auth.js no lo enlazó aún (no estorba si ya lo hizo)
    btnLogin.addEventListener("click", () => {
      if (window.MSALApp && MSALApp.login) MSALApp.login();
    });
    btnLogout.addEventListener("click", () => {
      if (window.MSALApp && MSALApp.logout) MSALApp.logout();
    });
  })();
</script>
</body>
</html>
