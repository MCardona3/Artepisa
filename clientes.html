<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Clientes · Artepisa SLP (Graph)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/style.css" />
  <style>
    /* ====== Layout original ====== */
    main.container { display:block; }
    main.container.split {
      display: grid;
      grid-template-columns: minmax(380px, 1fr) minmax(420px, 1fr);
      gap: 16px;
      align-items: start;
    }
    .card-form { display:none; }
    .split .card-form { display:block; }

    /* ====== Modo solo formulario ====== */
    main.container.form-only #card-list { display:none; }
    main.container.form-only #card-form {
      display:block;
      grid-column: 1 / -1;
      max-width: 860px;
      margin-inline: auto;
    }

    /* Responsive */
    @media (max-width: 980px){
      main.container.split { grid-template-columns: 1fr; }
    }

    .badge {
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 10px; border-radius:999px; font-size:.85rem;
      background:#eef5ff; color:#1f54b1; border:1px solid #d9e7ff;
    }

    /* ====== Paginación ====== */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .pagination button {
      border: 1px solid #ccc;
      background: #f8f8f8;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .pagination button.active {
      background: #1f54b1;
      color: white;
      border-color: #1f54b1;
    }
  </style>
</head>
<body class="theme-light">
  <!-- Guardia de sesión -->
  <script>
    const __acct = JSON.parse(sessionStorage.getItem('artepisa_account')||'null');
    if(!__acct){ location.href = 'index.html'; }
  </script>

  <header class="brand">
    <div class="logo">
      <img class="brandlogo" src="./img/arte.png?v=1" alt="ARTEPISA SLP">
      <div>
        <div class="brandname">ARTEPISA SLP</div>
        <div class="muted">Clientes</div>
      </div>
    </div>
    <a class="btn ghost" href="dashboard.html">Volver</a>
  </header>

  <main class="container tablewide" id="layout">
    <!-- LISTA -->
    <section class="card" id="card-list">
      <h2 style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <span style="flex:1">Clientes</span>
        <span class="badge" id="c-contador" title="Total de clientes">0</span>
        <button class="btn" id="btn-show-form" type="button" title="Crear o agregar cliente">Crear / Agregar</button>
      </h2>

      <div class="actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
        <input id="c-buscar" class="input" placeholder="Buscar por nombre, dirección, RFC, estado o contacto…" style="flex:1;min-width:240px" autocomplete="off">
        <button class="btn ghost" id="c-exportar" type="button" title="Exportar JSON">Exportar</button>

        <label class="btn ghost" for="c-importar" title="Importar JSON/CSV/TSV">Importar
          <input id="c-importar" type="file" accept=".json,.csv,.tsv,text/csv,text/tab-separated-values,application/json" style="display:none">
        </label>

        <button class="btn danger" id="c-reset" type="button" title="Borrar todos los clientes">Limpiar</button>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Teléfono</th>
              <th>Dirección</th>
              <th>RFC</th>
              <th>Estado</th>
              <th>Nombre de Contacto</th>
              <th>Teléfono de Contacto</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="c-tabla"></tbody>
        </table>
      </div>

      <!-- Selector y paginación -->
      <div style="margin-top:8px;text-align:center">
        <label>Mostrar 
          <select id="page-size">
            <option>5</option>
            <option selected>10</option>
            <option>20</option>
            <option>50</option>
          </select> registros por página
        </label>
      </div>

      <div id="paginacion" class="pagination"></div>
    </section>

    <!-- FORMULARIO -->
    <section class="card card-form" id="card-form">
      <h3>Formulario</h3>
      <div class="form">
        <div class="field">
          <label for="c-id">IDCliente</label>
          <input id="c-id" class="input" placeholder="(auto)" readonly>
          <small class="help">Se conserva el ID del archivo importado; si falta, se genera.</small>
        </div>

        <div class="field">
          <label for="c-nombre">Nombre</label>
          <input id="c-nombre" class="input" placeholder="Razón social o nombre comercial" autocomplete="off">
        </div>

        <div class="field">
          <label for="c-telefono">Teléfono</label>
          <input id="c-telefono" class="input"
                 inputmode="numeric"
                 autocomplete="tel"
                 maxlength="27"
                 data-phone-mask
                 placeholder="4441234567 o 4441234567/4449876543">
          <small class="help">10 dígitos o 2 teléfonos (20 dígitos) separados por “/”.</small>
        </div>

        <div class="field">
          <label for="c-direccion">Dirección</label>
          <input id="c-direccion" class="input" placeholder="Calle, #, Colonia, Ciudad" autocomplete="off">
        </div>

        <div class="field">
          <label for="c-rfc">RFC</label>
          <input id="c-rfc" class="input" placeholder="ABC123456XYZ" autocomplete="off">
        </div>

        <div class="field">
          <label for="c-estado">Estado</label>
          <input id="c-estado" class="input" placeholder="San Luis Potosí" autocomplete="off">
        </div>

        <div class="field">
          <label for="c-contacto">Nombre de Contacto</label>
          <input id="c-contacto" class="input" placeholder="Persona de contacto" autocomplete="off">
        </div>

        <div class="field">
          <label for="c-contacto-tel">Teléfono de Contacto</label>
          <input id="c-contacto-tel" class="input"
                 inputmode="numeric"
                 autocomplete="tel"
                 maxlength="27"
                 data-phone-mask
                 placeholder="4441234567 o 4441234567/4449876543">
          <small class="help">10 dígitos o 2 teléfonos (20 dígitos) separados por “/”.</small>
        </div>

        <div class="actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="c-guardar" type="button">Guardar</button>
          <button class="btn ghost" id="c-nuevo" type="button">Nuevo</button>
          <button class="btn danger" id="c-eliminar" type="button">Eliminar</button>
          <span style="flex:1"></span>
          <button class="btn ghost" id="c-cerrar" type="button" title="Ocultar formulario">Cerrar</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MSAL + módulos -->
  <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
  <script src="./js/msal-config.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/graph.js"></script>
  <script src="./js/data.js"></script>
  <script src="./js/clientes.js?v=10"></script>

  <!-- Contador reactivo -->
  <script>
    document.addEventListener("clientes:count", (e) => {
      const n = e.detail?.count ?? 0;
      const b = document.getElementById("c-contador");
      if (b) b.textContent = n;
    });
  </script>

  <!-- === Paginación integrada === -->
  <script>
  (function(){
    const tabla = document.getElementById('c-tabla');
    const paginacion = document.getElementById('paginacion');
    const selectPageSize = document.getElementById('page-size');

    let filasPorPagina = parseInt(selectPageSize.value, 10);
    let paginaActual = 1;
    let datos = [];

    // Expone renderizador para clientes.js
    window.ClientesUI = window.ClientesUI || {};
    window.ClientesUI.renderTabla = function(clientes) {
      datos = clientes;
      renderPagina(1);
    };

    selectPageSize.addEventListener('change', e => {
      filasPorPagina = parseInt(e.target.value, 10);
      renderPagina(1);
    });

    function renderPagina(num) {
      paginaActual = num;
      tabla.innerHTML = "";
      const inicio = (num - 1) * filasPorPagina;
      const fin = inicio + filasPorPagina;
      const paginaDatos = datos.slice(inicio, fin);

      for (const c of paginaDatos) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.id ?? ""}</td>
          <td>${c.nombre ?? ""}</td>
          <td>${c.telefono ?? ""}</td>
          <td>${c.direccion ?? ""}</td>
          <td>${c.rfc ?? ""}</td>
          <td>${c.estado ?? ""}</td>
          <td>${c.contacto ?? ""}</td>
          <td>${c.contactoTel ?? ""}</td>
          <td><button class="btn ghost btn-edit" data-id="${c.id}">✏️</button></td>
        `;
        tabla.appendChild(tr);
      }

      renderControles();
      document.dispatchEvent(new CustomEvent("clientes:count", { detail: { count: datos.length }}));
    }

    function renderControles() {
      const totalPaginas = Math.ceil(datos.length / filasPorPagina);
      paginacion.innerHTML = "";
      if (totalPaginas <= 1) return;

      const btnPrev = document.createElement("button");
      btnPrev.textContent = "⟨ Anterior";
      btnPrev.disabled = paginaActual === 1;
      btnPrev.onclick = () => renderPagina(paginaActual - 1);
      paginacion.appendChild(btnPrev);

      for (let i = 1; i <= totalPaginas; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === paginaActual) btn.classList.add("active");
        btn.onclick = () => renderPagina(i);
        paginacion.appendChild(btn);
      }

      const btnNext = document.createElement("button");
      btnNext.textContent = "Siguiente ⟩";
      btnNext.disabled = paginaActual === totalPaginas;
      btnNext.onclick = () => renderPagina(paginaActual + 1);
      paginacion.appendChild(btnNext);
    }
  })();
  </script>
</body>
</html>
