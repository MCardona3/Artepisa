<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Órdenes de Trabajo · Artepisa SLP (Graph)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/style.css" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="./img/arte.png?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/arte.png?v=1">

  <style>
    /* Layout: lista sola por defecto; formulario aparece al activar 'split' */
    main.container { display:block; }
    main.container.split {
      display:grid;
      grid-template-columns: minmax(380px, 1fr) minmax(420px, 1fr);
      gap:16px;
      align-items:start;
    }
    .card-form{ display:none; }
    .split .card-form{ display:block; }

    @media (max-width:980px){
      main.container.split{ grid-template-columns:1fr; }
    }

    /* Partidas */
    .items-head, .items-row {
      display:grid;
      grid-template-columns: 110px 1fr 180px 120px 110px;
      gap:8px; align-items:center;
    }
    .items-head { font-weight:600; margin-bottom:6px; }
    .items-row { margin-bottom:6px; }
    .items-row input[type="number"]{ text-align:right; }
    .items-box{ margin-top:16px; }
    .muted-sm{ font-size:.85rem; opacity:.8; }
    .btn.icon{ display:inline-flex; gap:6px; align-items:center; }
    .clip{font-weight:700}
    .table-print{ border-collapse:collapse; width:100%; }
    .table-print th,.table-print td{ border:1px solid #ccc; padding:6px; font-size:12px; }
  </style>
</head>
<body>
  <!-- GUARDIA DE SESIÓN: si no hay sesión, regresa a index -->
  <script>
    const __acct = JSON.parse(sessionStorage.getItem('artepisa_account')||'null');
    if(!__acct){ location.href = 'index.html'; }
  </script>

<header class="brand">
  <div class="logo">
    <img class="brandlogo" src="./img/arte.png?v=1" alt="ARTEPISA SLP">
    <div>
      <div class="brandname">ARTEPISA SLP</div>
      <div class="muted">Órdenes de Trabajo (OneDrive/SharePoint)</div>
    </div>
  </div>
  <a class="btn ghost" href="dashboard.html">Volver</a>
</header>

<!-- Por defecto SIN 'split' => solo listado -->
<main class="container" id="layout">
  <!-- LISTADO -->
  <section class="card" id="card-list">
    <h1 style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <span style="flex:1">Órdenes de Trabajo</span>
      <button class="btn" id="btn-show-form" type="button" title="Crear o agregar OT">Crear / Agregar</button>
    </h1>

    <div class="actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
      <input id="o-buscar" placeholder="Buscar por # o cliente" style="flex:1;min-width:220px">
    </div>

    <table>
      <thead>
      <tr>
        <th>#OT</th><th>Cliente</th><th>Depto</th><th>Emisión</th>
        <th>Entrega</th><th>Estatus</th><th>Prioridad</th><th>OC</th><th></th>
      </tr>
      </thead>
      <tbody id="o-tabla"></tbody>
    </table>
  </section>

  <!-- FORMULARIO (oculto hasta 'split') -->
  <section class="card card-form" id="card-form">
    <h2>Formulario</h2>
    <div class="form" id="ot-form">
      <div class="field"><span># OT</span><input id="o-num" type="number" inputmode="numeric" placeholder="(autogenera)"></div>

      <!-- Cliente con autocompletar desde BD -->
      <div class="field">
        <span>Cliente</span>
        <input id="o-cliente" placeholder="Cliente" list="dl-clientes" autocomplete="off" required>
        <datalist id="dl-clientes"></datalist>
      </div>

      <div class="field"><span>Departamento</span><input id="o-depto" placeholder="MAQUINADOS"></div>
      <div class="field"><span>Encargado</span><input id="o-enc" placeholder="Nombre del responsable"></div>
      <div class="field"><span>Fecha Emisión</span><input id="o-emision" type="date"></div>
      <div class="field"><span>Fecha Entrega</span><input id="o-entrega" type="date"></div>
      <div class="field"><span>Orden de Compra</span><input id="o-oc" placeholder="OPCIONAL"></div>
      <div class="field">
        <span>Estatus</span>
        <select id="o-est">
          <option value="ABIERTA">ABIERTA</option>
          <option value="EN PROCESO">EN PROCESO</option>
          <option value="EN ESPERA">EN ESPERA</option>
          <option value="CERRADA">CERRADA</option>
        </select>
      </div>
      <div class="field">
        <span>Prioridad</span>
        <select id="o-prio">
          <option value="NORMAL">NORMAL</option>
          <option value="ALTA">ALTA</option>
          <option value="URGENTE">URGENTE</option>
        </select>
      </div>
      <div class="field"><span>Descripción</span><input id="o-desc" placeholder="Trabajo a realizar"></div>

      <!-- PARTIDAS -->
      <div class="items-box">
        <div class="items-head">
          <div>Cantidad</div>
          <div>Descripción</div>
          <div>Plano</div>
          <div>Adjunto</div>
          <div></div>
        </div>
        <div id="items-container"></div>
        <button class="btn icon" id="btn-add-item" type="button">➕ Agregar partida</button>
        <div class="muted-sm" style="margin-top:6px">El adjunto se guarda en la OT como DataURL (base64). Archivos grandes pueden hacer pesado el JSON.</div>
      </div>

      <div class="actions" style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="o-guardar" type="button">Guardar</button>
        <button class="btn ghost" id="o-nuevo" type="button">Nuevo</button>
        <button class="btn" id="o-imprimir" type="button">Imprimir/PDF</button>
        <span style="flex:1"></span>
        <button class="btn ghost" id="o-cerrar" type="button" title="Ocultar formulario">Cerrar</button>
      </div>
    </div>
  </section>
</main>

<!-- MSAL + módulos (el orden importa) -->
<!-- Lógica -->
<p>Total OT: <strong id="ot-count">0</strong></p>
<table class="table">
  <thead><tr><th>Folio</th><th>Fecha</th><th>Estado</th><th></th></tr></thead>
  <tbody id="ot-tbody"></tbody>
</table>
<form id="ot-form" class="form">
  <input id="ot-folio" placeholder="Folio" required>
  <input id="ot-fecha" type="date" required>
  <input id="ot-estado" placeholder="Estado" required>
  <button class="btn">Guardar</button>
</form>


<!-- MSAL config -->

  <!-- MSAL config -->
  <script src="./js/msal-config.js"></script>
  <!-- MSAL library -->
  <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
  <!-- Auth -->
  <script src="./js/auth.js"></script>
  <!-- Órdenes de Trabajo (usa Graph) -->
  <script type="module" src="./js/ot-graph.js"></script>

</body>
</html>
